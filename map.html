<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Bang Away App</title>
    
<style type="text/css">
    #what-is-this{
        margin: 50px 0;
        text-align: center;
    }
    

    #map{
        width: 100%;
        height: 600px;
        position: relative;
    }
    
    
    #gotcha-at{
        position: absolute;
        width: 400px;
        top: 250px;
        right: 50px;
        text-align: center;
        background: white;
        background-color: rgba(255, 255, 255, .85);
        padding: 5px 20px;
        border-radius: 5px;
        -moz-border-radius: 5px;
        -webkit-border-radius: 5px;
        visibility: hidden;
    }
    
</style>

<!--Jquery Mobile-->
<link href="css/jQuery/jquery.mobile.theme-1.3.1.min.css" rel="stylesheet" type="text/css"/>
<link href="css/jQuery/jquery.mobile.structure-1.3.1.min.css" rel="stylesheet" type="text/css"/>

<script src="lib/jQuery/jquery-1.10.0.min.js" type="text/javascript"></script>
<script src="lib/jQuery/jquery.mobile-1.3.1.js" type="text/javascript"></script>
<script src="lib/jQuery/jquery.mobile-1.3.1.min.js" type="text/javascript"></script>

<!--Jquery Custom-->
<link href="css/bangAway.css" rel="stylesheet" type="text/css">
<script src="lib/swipe.js" type="text/javascript"></script>
    
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&key="></script>
<script>

if(localStorage['userID']==0)
{
    window.location.href = "index.html";
}


if(localStorage['newcountNotify'] != 0)
    {
        $('.Ncounter').text(localStorage['newcountNotify']).show(); 
    }
    else
    {
        $('this').removeClass('msg-iconh').addClass('msg-icon');
        $('.Ncounter').text('0').hide();
        $('.notif-bot').hide();
    }
    
    var notificationInterval = "http://www.paighaam.com/service/getNotifications.php?uid="+localStorage['userID']+"&state=1";
    var thetitle = $('title').text();
    

    setInterval(function(){

            jQuery.ajax({
                type: 'GET',
                url: notificationInterval,                                                                                                                                              
                dataType: 'jsonp', 
              success: function(data) {
                var countNotif = parseInt($('.Ncounter').text());
                
                if(data.Count == 0 && countNotif >0)
                {
                    $('.Ncounter').text(0).hide();
                }

                if(data.Count != 0)
                {   
                    if(data.Count > countNotif)
                    {
                    var newcountNotif = data.Count;
                    $('.Ncounter').text(newcountNotif).show();
                    localStorage['newcountNotify']= data.Count;
                    //$('Ntitle').text('('+newcountNotif+') '+thetitle);
                    
                        jQuery('<div/>', {
                            id: 'notif-bot',
                            class : 'notif-bot alert alert-info',
                            text: 'You just got a notification!'
                            }).appendTo('.notify-bot-cnt')
                            .delay(5000)
                            .fadeOut();
                    }
                }
              }
            });
        }, 5000 );

        
        $('#notifications').click(function(){
                $('this').removeClass('msg-iconh').addClass('msg-icon');
                $('.Ncounter').text('0').hide();
                $('.notif-bot').hide();
                $('title').text(thetitle);
                localStorage['newcountNotify'] = 0;
                setNotificationState();
            });

       function setNotificationState()
       {
           var setNotificationCounter = "http://www.paighaam.com/service/setNotificationState.php?uid="+localStorage['userID'];

          jQuery.ajax({

            type: 'GET',
            url: setNotificationCounter,                                                                                                                                              
            dataType: 'jsonp',         
            success: function(data)
            { 

              console.log('Success!');

            },
            error: function() { console.log('Uh Oh Something Went Wrong!'); },

          });
        }



var mapDiv;
window.onload = function(){
    mapDiv = document.getElementById('map');
    mapDiv.innerHTML = 'Trying to get your location...';
    if(navigator.geolocation)
        navigator.geolocation.getCurrentPosition(handleGetCurrentPosition, handleGetCurrentPositionError);
}


function handleGetCurrentPosition(location){
    
    var position = new google.maps.LatLng(location.coords.latitude, location.coords.longitude)
    
    var map = new google.maps.Map(mapDiv, {
        zoom: 18,
        center: position,
        mapTypeId: google.maps.MapTypeId.HYBRID
    });
    
    var marker = new google.maps.Marker({
        position: position,
        map: map
    })
    
    new google.maps.Geocoder().geocode({location: position}, handleGeocoderGetLocations);
}


function handleGeocoderGetLocations( addresses, status ){
        if (status != google.maps.GeocoderStatus.OK)
            return maybe_log( 'failed to talk to google' );
            
        var city = getCityFromPlacemarks(addresses);
        var country = getCountryFromPlacemarks(addresses);
        
        var mapOverlay = document.getElementById('gotcha-at');
        mapOverlay.innerHTML = 'Gotcha at <strong>' + addresses[0].formatted_address + '</strong>';
        mapOverlay.style.visibility = 'visible';
    }
    
    
function getCityFromPlacemarks( placemarks ){
    return extractNameFromGoogleGeocoderResults('locality', placemarks)
}


function getCountryFromPlacemarks(placemarks){
    return extractNameFromGoogleGeocoderResults('country', placemarks)
}


function extractNameFromGoogleGeocoderResults(type, results){
    for( var i = 0, l = results.length; i < l; i ++)
        for(var j = 0, l2 = results[i].types.length; j < l2; j++ )
            if( results[i].types[j] == type )
                 return results[i].address_components[0].long_name;
    return ''
}
    
function handleGetCurrentPositionError(){
    mapDiv.innerHTML = 'Something went horribly wrong!';
}

</script>

    
</head>
<body>
    
<div data-role="page" id="fcalendar">
    <div data-role="header">
    </div>
    <div data-role="content">
    <div class="ui-grid-solo">
            <div class="ui-block-a"><h2 style="
                    background-color: #ffdd00;
                    font-weight:bold;
                    height: 80px;
                    margin-left: -20px;
                    margin-right: -20px;
                    margin-top: -14px;
                    margin-bottom: -15px;
                    padding-left: 30px;
                    padding-top: 30px;">Your Location</h2>
                  </div>
        </div>
    <div class="ui-grid-solo">
     <div class="ui-block-a" style="margin-left: -15px; margin-right: -15px;">
               <div id="map"><noscript>
            We need JS for this.
             </noscript></div>
        <div id="gotcha-at"></div>
     </div>
   </div>
 </div>
 <div class="notify-bot-cnt"></div> 
    <div data-role="footer" data-id="fcalendar" data-position="fixed">        
        <div data-role="navbar">
            <ul>
                <li><a href="home.html" rel="external" data-ajax="false"><img width="32px" height="28px" src="images/bangaway_home.png" alt="details"></a></li>
                <li><a href="#"><img width="32px" height="28px" src="images/bangaway_groups.png" alt="details"></a></li>
                <li>
                    <a id="notifications" href="notifications.html" rel="external" data-ajax="false">
                        <img id="counterIcon" width="32px" height="28px" src="images/bangaway_chat.png" alt="details">
                        <id class="Ncounter" style="display:none">0</id>
                    </a>
                </li>
                <li><a href="#"><img width="32px" height="28px" src="images/bangaway_settings.png" alt="details"></a></li>
                <li><a href="#"><img width="32px" height="28px" src="images/bangaway_keydates.png" alt="details"></a></li>
            </ul>
        </div> 
    </div><!-- /footer -->

</div>

</body>
</html>