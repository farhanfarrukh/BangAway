<!DOCTYPE html> 
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bang Away App</title>

<!--Jquery Mobile-->
<link href="css/jQuery/jquery.mobile.theme-1.3.1.min.css" rel="stylesheet" type="text/css"/>
<link href="css/jQuery/jquery.mobile.structure-1.3.1.min.css" rel="stylesheet" type="text/css"/>

<script src="lib/jQuery/jquery-1.10.0.min.js" type="text/javascript"></script>
<script src="lib/jQuery/jquery.mobile-1.3.1.js" type="text/javascript"></script>
<script src="lib/jQuery/jquery.mobile-1.3.1.min.js" type="text/javascript"></script>

<!--Jquery Custom-->
<link href="css/bangAway.css" rel="stylesheet" type="text/css">
<script src="js/swipe.js" type="text/javascript"></script>



<script>
$(function() {
    $(document).ready(function() {


if(localStorage['newcountNotify'] != 0)
    {
        $('.Ncounter').text(localStorage['newcountNotify']).show(); 
    }
    else
    {
        $('this').removeClass('msg-iconh').addClass('msg-icon');
        $('.Ncounter').text('0').hide();
        $('.notif-bot').hide();
    }
    
    var notificationInterval = "http://www.paighaam.com/service/getNotifications.php?uid="+localStorage['userID']+"&state=1";
    var thetitle = $('title').text();
    

    setInterval(function(){

            jQuery.ajax({
                type: 'GET',
                url: notificationInterval,                                                                                                                                              
                dataType: 'jsonp', 
              success: function(data) {
                var countNotif = parseInt($('.Ncounter').text());
                
                if(data.Count == 0 && countNotif >0)
                {
                    $('.Ncounter').text(0).hide();
                }

                if(data.Count != 0)
                {   
                    if(data.Count > countNotif)
                    {
                    var newcountNotif = data.Count;
                    $('.Ncounter').text(newcountNotif).show();
                    localStorage['newcountNotify']= data.Count;
                    //$('Ntitle').text('('+newcountNotif+') '+thetitle);
                    
                        jQuery('<div/>', {
                            id: 'notif-bot',
                            class : 'notif-bot alert alert-info',
                            text: 'You just got a notification!'
                            }).appendTo('.notify-bot-cnt')
                            .delay(5000)
                            .fadeOut();
                    }
                }
              }
            });
        }, 5000 );

        
        $('#notifications').click(function(){
                $('this').removeClass('msg-iconh').addClass('msg-icon');
                $('.Ncounter').text('0').hide();
                $('.notif-bot').hide();
                $('title').text(thetitle);
                localStorage['newcountNotify'] = 0;
                setNotificationState();
            });

       function setNotificationState()
       {
           var setNotificationCounter = "http://www.paighaam.com/service/setNotificationState.php?uid="+localStorage['userID'];

          jQuery.ajax({

            type: 'GET',
            url: setNotificationCounter,                                                                                                                                              
            dataType: 'jsonp',         
            success: function(data)
            { 

              console.log('Success!');

            },
            error: function() { console.log('Uh Oh Something Went Wrong!'); },

          });
        }


      var userID = localStorage['userID'];
      var serviceURL = "http://www.paighaam.com/service/getAllowance.php?id=" + userID;

          jQuery.ajax({

            type: 'GET',
            url: serviceURL,                                                                                                                                              
            dataType: 'jsonp',         
            success: function(data)
            { 
              console.log('Success!');
              displayAllowance(data);
              renderGraph(data);
            },
            error: function() { console.log('Uh Oh Something Went Wrong!'); },

          });
          

          function displayAllowance(data)
          {
            $('.h-allowance span').html(data.Allowance);
            $('.h-remaining span').html(data.HolidayLeft);
            //$('.in-stock span').html(data.HolidayTaken);
            
          }


          function renderGraph(data)
          {

            var taken = data.HolidayTaken;
            var left = data.HolidayLeft;

            $('#container').highcharts({
                chart: {
              backgroundColor: {
                     linearGradient: { x1: 1, y1: 1, x2: 1, y2: 1 },
                     stops: [
                        [0, 'rgba(255, 255, 255, 1)'],
                        [1, 'rgba(255, 255, 255, 1)']
                     ]
                  },
                plotBackgroundColor: 'rgba(255, 213, 0, .9)',
                plotShadow: false,
                plotBorderWidth: 0
            },
                title: {
                    text: 'Annual Leaves'
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage}%</b>',
                    percentageDecimals: 0
                },
                plotOptions: {
                    pie: {
                        showInLegend: true,
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: false,
                            color: '#000000',
                            connectorColor: '#000000',
                            formatter: function() {
                                return '<b>'+ this.point.name +'</b>: '+ this.percentage +' %';
                            }
                        }
                    }
                },
                series: [{
                    type: 'pie',
                    name: 'Holidays',
                    data: [
                        ['Taken', parseInt(taken)],
                        ['Left',  parseInt(left)]
                        //['Sick', 10]
                    ]
                }]
            });

          }



    });
});

</script>

<script src="lib/highcharts/highcharts.js"></script>
<script src="lib/highcharts/modules/exporting.js"></script>

</head> 
<body> 

<div data-role="page" id="profile">
    
    <div data-role="header">
    </div>
    
    <div data-role="content">   
        <div class="ui-grid-solo">
            <div class="ui-block-a"><h2>Annual Leaves</h2></div>
        </div>   
        <div class="ui-grid-a">
            <div class="ui-block-a">
                <div class="h-allowance">
                    <h3>Holiday Allowance</h3>
                    <span></span>
                </div>
            </div>
            <div class="ui-block-b">
                <div class="h-remaining">
                    <h3>Holiday Remaining</h3>
                    <span></span>
                </div>
            </div>       
        </div>
        <div class="ui-grid-solo">
            <div class="ui-block-a">
                <div id="container" style="min-width: 300px; height: 300px; margin: 0 auto; margin-top: 20px;"></div>
            </div>
        </div>   
    </div>
    <div class="notify-bot-cnt"></div> 
    <div data-role="footer" data-id="fprofile" data-position="fixed">        
        <div data-role="navbar">
            <ul>
                <li><a href="home.html" rel="external" data-ajax="false" data-transition="slide"><img width="32px" height="28px" src="images/bangaway_home.png" alt="details"></a></li>
                <li><a href="#"><img width="32px" height="28px" src="images/bangaway_groups.png" alt="details"></a></li>
                <li>
                    <a id="notifications" href="notifications.html" rel="external" data-ajax="false">
                        <img id="counterIcon" width="32px" height="28px" src="images/bangaway_chat.png" alt="details">
                        <id class="Ncounter" style="display:none">0</id>
                    </a>
                </li>
                <li><a href="#"><img width="32px" height="28px" src="images/bangaway_settings.png" alt="details"></a></li>
                <li><a href="#"><img width="32px" height="28px" src="images/bangaway_keydates.png" alt="details"></a></li>
            </ul>
        </div> 
    </div><!-- /footer -->

</div>

</body>
</html>